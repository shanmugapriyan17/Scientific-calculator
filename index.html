<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Scientific Calculator</title>
    <link rel="stylesheet" href="./style.css" />
  </head>
  <body>
    <div class="wrap">
      <div class="calc" id="calculator">
        <!-- LEFT: screen + basic keypad (now merged with scientific below) -->
        <div class="left">
          <div class="topbar">
            <div style="font-weight: 800">Scientific Calculator</div>
            <div class="badges">
              <div class="badge" id="modeBadge">Rad</div>
              <div
                class="badge"
                id="memBadge"
                title="Memory (MR to read)"
                style="display: none"
              >
                M
              </div>
            </div>
          </div>

          <div class="screen" role="region" aria-label="calculator screen">
            <div
              id="expr"
              contenteditable="true"
              spellcheck="false"
              aria-label="expression"
            ></div>
            <div id="result">0</div>
          </div>

          <div class="toolbar" style="margin-top: 8px">
            <div class="tool-btn" id="appendToggle">Append</div>
            <div class="tool-btn" id="prependToggle">Prepend</div>
            <div class="tool-btn" id="reverseBtn">Reverse</div>
            <div class="tool-btn" id="degToggle">Rad/Deg</div>
          </div>

          <div class="keygrid" id="keys">
            <!-- Row 1 -->
            <button class="key alt" data-insert="(">(</button>
            <button class="key alt" data-insert=")">)</button>
            <button class="key alt" data-act="mc">MC</button>
            <button class="key alt" data-act="m+">M+</button>
            <button class="key alt" data-act="m-">M-</button>
            <button class="key alt" data-act="mr">MR</button>

            <!-- Row 2 (functions) -->
            <button class="key alt" data-act="2nd">2nd</button>
            <button class="key alt" data-insert="sqr(">x¬≤</button>
            <button class="key alt" data-insert="cube(">x¬≥</button>
            <button class="key alt" data-insert="pow(">x ∏</button>
            <button class="key alt" data-insert="exp(">eÀ£</button>
            <button class="key alt" data-insert="pow10(">10À£</button>

            <!-- Row 3 -->
            <button class="key alt" data-insert="inv(">1/x</button>
            <button class="key alt" data-insert="sqrt(">‚àöx</button>
            <button class="key alt" data-insert="cbrt(">‚àõx</button>
            <button class="key alt" data-insert="yroot("> ∏‚àöx</button>
            <button class="key alt" data-insert="ln(">ln</button>
            <button class="key alt" data-insert="log10(">log‚ÇÅ‚ÇÄ</button>

            <!-- Row 4 -->
            <button class="key alt" data-insert="fact(">x!</button>
            <button class="key alt" data-insert="sin(">sin</button>
            <button class="key alt" data-insert="cos(">cos</button>
            <button class="key alt" data-insert="tan(">tan</button>
            <button class="key alt" data-insert="E">e</button>
            <button class="key alt" data-act="EE">EE</button>

            <!-- Row 5 -->
            <button class="key alt" data-act="rand">Rand</button>
            <button class="key alt" data-insert="sinh(">sinh</button>
            <button class="key alt" data-insert="cosh(">cosh</button>
            <button class="key alt" data-insert="tanh(">tanh</button>
            <button class="key alt" data-insert="PI">œÄ</button>
            <button class="key alt" data-act="toggleDeg">Deg</button>

            <!-- Row 6 (basic ops) -->
            <button class="key alt" data-act="ac">AC</button>
            <button class="key alt" data-act="sign">+/‚àí</button>
            <button class="key alt" data-act="percent">%</button>
            <button class="key op" data-insert=" √∑ ">√∑</button>
            <button class="key op" data-insert=" √ó ">√ó</button>
            <button class="key op" data-insert=" ‚àí ">‚àí</button>

            <!-- Row 7 numbers -->
            <button class="key" data-insert="7">7</button>
            <button class="key" data-insert="8">8</button>
            <button class="key" data-insert="9">9</button>
            <button class="key op" data-insert=" + ">+</button>
            <button class="key alt icon" title="Backspace" data-act="back">
              ‚å´
            </button>
            <button class="key op" data-act="equals">=</button>

            <!-- Row 8 -->
            <button class="key" data-insert="4">4</button>
            <button class="key" data-insert="5">5</button>
            <button class="key" data-insert="6">6</button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>

            <!-- Row 9 -->
            <button class="key" data-insert="1">1</button>
            <button class="key" data-insert="2">2</button>
            <button class="key" data-insert="3">3</button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>

            <!-- Row 10 -->
            <button class="key alt icon" title="Calculator">üßÆ</button>
            <button class="key" data-insert="0">0</button>
            <button class="key" data-insert=".">.</button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>
            <button class="key w3 alt" style="visibility: hidden"></button>
          </div>
        </div>

        <!-- NOTE: right column removed (merged). floating sci button kept if you want overlay on small screens -->
      </div>

      <!-- floating toggle for small screens to show scientific -->
      <button
        class="sci-float"
        id="sciFloat"
        title="Scientific"
        aria-hidden="true"
        style="display: none"
      >
        ‚â°
      </button>
    </div>

    <script>
      (function () {
        // Elements
        const exprEl = document.getElementById("expr");
        const resEl = document.getElementById("result");
        const keysEl = document.getElementById("keys");
        const modeBadge = document.getElementById("modeBadge");
        const memBadge = document.getElementById("memBadge");
        const appendToggle = document.getElementById("appendToggle");
        const prependToggle = document.getElementById("prependToggle");
        const reverseBtn = document.getElementById("reverseBtn");
        const degToggle = document.getElementById("degToggle");
        const sciPanel = document.getElementById("sciPanel");
        const sciFloat = document.getElementById("sciFloat");

        // State
        let expression = "";
        let isDeg = false;
        let memory = 0;
        let alt = false; // 2nd functions (asin etc)
        let appendMode = false;
        let prependMode = false;

        // Math helpers
        const toRad = (x) => (isDeg ? (x * Math.PI) / 180 : x);
        const sin = (x) => Math.sin(toRad(x));
        const cos = (x) => Math.cos(toRad(x));
        const tan = (x) => Math.tan(toRad(x));
        const asin = (x) =>
          isDeg ? (Math.asin(x) * 180) / Math.PI : Math.asin(x);
        const acos = (x) =>
          isDeg ? (Math.acos(x) * 180) / Math.PI : Math.acos(x);
        const atan = (x) =>
          isDeg ? (Math.atan(x) * 180) / Math.PI : Math.atan(x);
        const sinh = (x) => Math.sinh(x);
        const cosh = (x) => Math.cosh(x);
        const tanh = (x) => Math.tanh(x);
        const ln = (x) => Math.log(x);
        const log10 = (x) => Math.log10(x);
        const sqrt = (x) => Math.sqrt(x);
        const cbrt = (x) => Math.cbrt(x);
        const inv = (x) => 1 / x;
        const sqr = (x) => x * x;
        const cube = (x) => x * x * x;
        const exp = (x) => Math.exp(x);
        const pow10 = (x) => Math.pow(10, x);
        const pow = (a, b) => Math.pow(a, b);
        const yroot = (x, y) => Math.pow(x, 1 / y);
        const fact = (n) => {
          n = Math.trunc(n);
          if (n < 0) return NaN;
          let r = 1;
          for (let i = 2; i <= n; i++) r *= i;
          return r;
        };
        const Rand = () => Math.random();

        // expose helpers for evaluator
        Object.assign(window, {
          sin,
          cos,
          tan,
          asin,
          acos,
          atan,
          sinh,
          cosh,
          tanh,
          ln,
          log10,
          sqrt,
          cbrt,
          inv,
          sqr,
          cube,
          exp,
          pow10,
          pow,
          yroot,
          fact,
          Rand,
          PI: Math.PI,
          E: Math.E,
        });

        // initialize UI
        exprEl.textContent = "";
        resEl.textContent = "0";
        modeBadge.textContent = isDeg ? "Deg" : "Rad";

        // Make contenteditable reliably editable without overwriting caret while typing:
        // - Don't overwrite exprEl text when user is actively focused in it (prevents caret jumping)
        // - Sync final content on blur/input
        exprEl.setAttribute("tabindex", "0");
        exprEl.addEventListener("click", () => {
          // ensure focus on click
          if (document.activeElement !== exprEl) exprEl.focus();
        });
        exprEl.addEventListener("blur", () => {
          // when user leaves the field, sync the expression and UI
          expression = exprEl.textContent || "";
          updateUI();
        });

        // Helpers
        function updateUI() {
          // do not overwrite user typing selection/caret
          if (document.activeElement !== exprEl) {
            exprEl.textContent = expression;
          }
          try {
            const v = evaluate(expression);
            resEl.textContent =
              v === undefined || v === null || Number.isNaN(v)
                ? "0"
                : formatNumber(v);
          } catch (e) {
            resEl.textContent = "Err";
          }
          modeBadge.textContent = isDeg ? "Deg" : "Rad";
          memBadge.style.display = memory !== 0 ? "inline-block" : "none";
          // toolbar active classes
          appendToggle.classList.toggle("active", appendMode);
          prependToggle.classList.toggle("active", prependMode);
        }

        function formatNumber(x) {
          if (!isFinite(x)) return String(x);
          if (Math.abs(x) >= 1e10 || (Math.abs(x) < 1e-6 && x !== 0))
            return x.toExponential(8);
          return Number(x.toPrecision(12)).toString();
        }

        // evaluate with replacements for pretty operators
        function evaluate(exp) {
          if (!exp) return 0;
          let s = String(exp);

          // replace pretty unicode operators with JS equivalents
          s = s
            .replace(/ √ó /g, " * ")
            .replace(/ √∑ /g, " / ")
            .replace(/ ‚àí /g, " - ")
            .replace(/ \+ /g, " + ")
            .replace(/PI/g, "(PI)")
            .replace(/E(?![A-Za-z])/g, "(E)");

          // EE handling (like 1 EE 3 => 1e3)
          s = s.replace(/(\d+(?:\.\d+)?)[ ]?EE[ ]?([+\-]?\d+)/gi, "($1e$2)");

          // autoclose parentheses
          const opens = (s.match(/\(/g) || []).length;
          const closes = (s.match(/\)/g) || []).length;
          if (opens > closes) s += ")".repeat(opens - closes);

          // Evaluate safely-ish
          // eslint-disable-next-line no-new-func
          return Function('"use strict";return (' + s + ")")();
        }

        // editing primitives
        function appendText(txt) {
          expression += txt;
          updateUI();
        }
        function prependText(txt) {
          expression = txt + expression;
          updateUI();
        }
        function backspace() {
          expression = expression.slice(0, -1);
          updateUI();
        }
        function clearAll() {
          expression = "";
          updateUI();
        }

        function addDot() {
          // prevent double dot in last number
          const parts = expression.split(/[^0-9.]/);
          const last = parts[parts.length - 1] || "";
          if (last.includes(".")) return;
          appendText(".");
        }

        function plusMinus() {
          const m = expression.match(
            /(.*?)(\([^()]*\)|\d*\.?\d+(?:e[+\-]?\d+)?|PI|E)\s*$/i
          );
          if (!m) {
            appendText("(-");
            return;
          }
          const head = m[1],
            token = m[2];
          if (/\(-/.test(head.slice(-2)) && expression.endsWith(")")) {
            expression = head.slice(0, -2) + token;
          } else {
            expression = `${head}(-${token})`;
          }
          updateUI();
        }

        function percent() {
          const m = expression.match(/(.*?)(\d*\.?\d+(?:e[+\-]?\d+)?)\s*$/i);
          if (!m) return;
          expression = `${m[1]}(${m[2]} / 100)`;
          updateUI();
        }

        // memory
        function mplus() {
          const v = evaluate(expression || "0");
          memory += isFinite(v) ? v : 0;
          updateUI();
        }
        function mminus() {
          const v = evaluate(expression || "0");
          memory -= isFinite(v) ? v : 0;
          updateUI();
        }
        function mclear() {
          memory = 0;
          updateUI();
        }
        function mread() {
          appendText(formatNumber(memory));
        }

        // modes
        function setAppend(on) {
          appendMode = !!on;
          if (appendMode) prependMode = false;
          updateUI();
        }
        function setPrepend(on) {
          prependMode = !!on;
          if (prependMode) appendMode = false;
          updateUI();
        }

        // Reverse
        function doReverse() {
          expression = expression.split("").reverse().join("");
          updateUI();
        }

        // buttons listener
        keysEl.addEventListener("click", (ev) => {
          const b = ev.target.closest("button");
          if (!b) return;
          const act = b.dataset.act;
          const ins = b.dataset.insert;

          // handle modes: append/prepend when clicking any normal button that inserts text
          if (!act && ins) {
            if (appendMode) {
              appendText(ins);
              return;
            }
            if (prependMode) {
              prependText(ins);
              return;
            }
            appendText(ins);
            return;
          }

          if (!act && !ins) {
            // plain button: text content (numbers, ., etc)
            const txt = b.textContent.trim();
            if (appendMode) {
              appendText(txt);
              return;
            }
            if (prependMode) {
              prependText(txt);
              return;
            }
            // default: if it's digit or dot or operator we append normally
            appendText(txt);
            return;
          }

          // actions
          switch (act) {
            case "ac":
              clearAll();
              break;
            case "back":
              backspace();
              break;
            case "equals":
              try {
                expression = String(evaluate(expression));
              } catch (e) {
                /* leave */
              }
              updateUI();
              break;
            case "percent":
              percent();
              break;
            case "sign":
              plusMinus();
              break;
            case "rand":
              appendText(String(Math.random()));
              break;
            case "EE":
              appendText("EE");
              break;
            case "toggleDeg":
            case "Deg":
              isDeg = !isDeg;
              updateUI();
              break;
            case "mc":
              mclear();
              break;
            case "m+":
              mplus();
              break;
            case "m-":
              mminus();
              break;
            case "mr":
              mread();
              break;
            case "2nd":
              alt = !alt;
              toggleSecond();
              break;
            default:
              break;
          }
        });

        // 2nd toggle - swap sin<->asin etc
        function toggleSecond() {
          const map = [
            {
              sel: 'button[data-insert="sin("]',
              a: { label: "sin", tok: "sin(" },
              b: { label: "asin", tok: "asin(" },
            },
            {
              sel: 'button[data-insert="cos("]',
              a: { label: "cos", tok: "cos(" },
              b: { label: "acos", tok: "acos(" },
            },
            {
              sel: 'button[data-insert="tan("]',
              a: { label: "tan", tok: "tan(" },
              b: { label: "atan", tok: "atan(" },
            },
          ];
          map.forEach(({ sel, a, b }) => {
            const btn = document.querySelector(sel);
            if (!btn) return;
            if (alt) {
              btn.textContent = b.label;
              btn.dataset.insert = b.tok;
            } else {
              btn.textContent = a.label;
              btn.dataset.insert = a.tok;
            }
          });
        }

        // keyboard support + special handling for append/prepend modes
        window.addEventListener("keydown", (e) => {
          const k = e.key;
          const isPrintable =
            /^[0-9+\-*/().%]$/.test(k) ||
            k === "." ||
            k === "*" ||
            k === "+" ||
            k === "-" ||
            k === "/" ||
            k === "%";
          if (isPrintable) {
            // intercept if append/prepend mode is active
            if (appendMode) {
              e.preventDefault();
              appendText(k);
              return;
            } else if (prependMode) {
              e.preventDefault();
              prependText(k);
              return;
            } else {
              // default ‚Äî insert at caret in contenteditable
              // let contenteditable handle it; but we also update our expression variable after short delay
              // do nothing here; rely on input event on exprEl
              return;
            }
          }
          if (k === "Backspace") {
            e.preventDefault();
            backspace();
            return;
          }
          if (k === "Enter") {
            e.preventDefault();
            try {
              expression = String(evaluate(expression));
            } catch {}
            updateUI();
            return;
          }
        });

        // allow typing into expression area and keep expression in sync
        exprEl.addEventListener("input", () => {
          // read textContent as expression (user can type freely)
          expression = exprEl.textContent || "";
          updateUI();
        });

        // toolbar UI actions
        appendToggle.addEventListener("click", () => {
          setAppend(!appendMode);
        });
        prependToggle.addEventListener("click", () => {
          setPrepend(!prependMode);
        });
        reverseBtn.addEventListener("click", () => {
          doReverse();
        });
        degToggle.addEventListener("click", () => {
          isDeg = !isDeg;
          updateUI();
        });

        // small-screen scientific toggle: show/hide overlay using cloned sciGrid (works same as before)
        function setupSciFloat() {
          const floatBtn = document.getElementById("sciFloat");
          if (!floatBtn) return;
          floatBtn.style.display = window.innerWidth <= 980 ? "flex" : "none";
          floatBtn.addEventListener("click", () => {
            // create an overlay panel that slides up with contents of sciPanel
            let overlay = document.getElementById("sciOverlay");
            if (overlay) {
              overlay.remove();
              return;
            }
            overlay = document.createElement("div");
            overlay.id = "sciOverlay";
            overlay.style.position = "fixed";
            overlay.style.left = "0";
            overlay.style.right = "0";
            overlay.style.bottom = "0";
            overlay.style.background =
              "linear-gradient(180deg,#232428,#1f1f1f)";
            overlay.style.padding = "12px";
            overlay.style.borderTopLeftRadius = "12px";
            overlay.style.borderTopRightRadius = "12px";
            overlay.style.boxShadow = "0 -8px 30px rgba(0,0,0,.6)";
            overlay.style.zIndex = 9999;
            overlay.style.display = "grid";
            overlay.style.gridTemplateColumns = "repeat(5,1fr)";
            overlay.style.gap = "8px";
            // copy sciGrid buttons
            const nodes = document.querySelectorAll("#sciGrid > button");
            nodes.forEach((n) => {
              const clone = n.cloneNode(true);
              clone.style.padding = "14px";
              clone.addEventListener("click", (ev) => {
                // forward click to keys behavior by dispatching click on same dataset
                const ins = clone.dataset.insert;
                if (appendMode) appendText(ins || clone.innerText);
                else if (prependMode) prependText(ins || clone.innerText);
                else appendText(ins || clone.innerText);
                // small animation then remove overlay
                overlay.remove();
              });
              overlay.appendChild(clone);
            });
            // close area
            const close = document.createElement("button");
            close.textContent = "Close";
            close.style.gridColumn = "span 5";
            close.style.padding = "12px";
            close.style.background = "var(--red)";
            close.style.color = "#fff";
            close.style.border = "none";
            close.style.borderRadius = "8px";
            close.addEventListener("click", () => overlay.remove());
            overlay.appendChild(close);
            document.body.appendChild(overlay);
          });
        }

        // respond to resize to show small-screen float
        window.addEventListener("resize", () => {
          setupSciFloat();
        });
        // initial
        setupSciFloat();
        updateUI();

        // expose some functions to global for debugging if needed
        window.calcHelpers = {
          setAppend,
          setPrepend,
          appendText,
          prependText,
          clearAll,
          backspace,
          evaluate,
        };
      })();
    </script>
  </body>
</html>
